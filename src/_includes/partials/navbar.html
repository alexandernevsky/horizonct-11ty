<nav class="bg-background border-b border-border sticky top-0 z-50 shadow-sm" x-data="{ isOpen: false, darkMode: false }" x-init="darkMode = localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches); if (darkMode) document.documentElement.classList.add('dark'); $watch('darkMode', value => { localStorage.setItem('darkMode', value); document.documentElement.classList.toggle('dark', value) })">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo -->
      <div class="flex-shrink-0">
        {% if lang == 'ru' %}
          {% set homeUrl = '/ru/' %}
        {% else %}
          {% set homeUrl = '/' %}
        {% endif %}
        <a href="{{ homeUrl }}" class="text-xl font-bold text-foreground hover:text-primary transition-colors">
          {{ settings.company_name }}
        </a>
      </div>

      <!-- Desktop Navigation -->
      <nav class="hidden md:block ml-10" aria-label="Main navigation">
        <ul class="flex items-baseline space-x-4">
          {% if navigation[lang] %}
            {% for item in navigation[lang] %}
              {% set isActive = page.url | isActive(item.url) %}
              <li>
                <a 
                  href="{{ item.url }}" 
                  class="group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 {% if isActive %}bg-accent/50 text-primary font-semibold{% else %}text-foreground{% endif %}"
                  {% if isActive %}data-active="true" aria-current="page"{% endif %}
                >
                  {{ item.text }}
                </a>
              </li>
            {% endfor %}
          {% endif %}
        </ul>
      </nav>

      <!-- Language Switcher, Theme Toggle & Mobile Menu Button -->
      <div class="flex items-center space-x-4">
        <!-- Language Switcher Dropdown -->
        {% if lang == 'ru' %}
          {% set currentLangCode = 'RU' %}
          {% set enUrl = page | switchLang('en') %}
          {% set ruUrl = page.url %}
        {% else %}
          {% set currentLangCode = 'EN' %}
          {% set enUrl = page.url %}
          {% set ruUrl = page | switchLang('ru') %}
        {% endif %}
        
        <div class="relative" x-data="{ open: false }" @click.away="open = false">
          <button
            type="button"
            @click="open = !open"
            class="flex h-10 w-24 items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
            aria-haspopup="listbox"
            :aria-expanded="open"
          >
            <span class="font-semibold">{{ currentLangCode }}</span>
            <span class="h-4 w-4 opacity-50 transition-transform duration-200" :class="{ 'rotate-180': open }">
              {% icon "chevron-down", { size: 16, class: "h-4 w-4" } %}
            </span>
          </button>
          
          <ul
            x-show="open"
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="absolute right-0 z-50 mt-1 w-40 overflow-auto rounded-md border bg-popover p-1 text-popover-foreground shadow-md"
            role="listbox"
            style="display: none;"
          >
            <li
              role="option"
              @click="open = false; window.location.href = '{{ enUrl }}'"
              class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-muted hover:text-foreground focus:bg-muted focus:text-foreground transition-colors {% if lang == 'en' %}bg-primary/10 text-primary font-medium{% endif %}"
            >
              <span>English</span>
              {% if lang == 'en' %}
              <span class="ml-auto h-4 w-4">
                {% icon "check", { size: 16, class: "h-4 w-4" } %}
              </span>
              {% endif %}
            </li>
            <li
              role="option"
              @click="open = false; window.location.href = '{{ ruUrl }}'"
              class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-muted hover:text-foreground focus:bg-muted focus:text-foreground transition-colors {% if lang == 'ru' %}bg-primary/10 text-primary font-medium{% endif %}"
            >
              <span>Русский</span>
              {% if lang == 'ru' %}
              <span class="ml-auto h-4 w-4">
                {% icon "check", { size: 16, class: "h-4 w-4" } %}
              </span>
              {% endif %}
            </li>
          </ul>
        </div>
        
        <!-- Theme Toggle -->
        <button 
          @click="darkMode = !darkMode" 
          class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 w-10"
          aria-label="Toggle theme"
        >
          <span x-show="!darkMode" class="w-5 h-5">
            {% icon "moon", { size: 20, class: "w-5 h-5" } %}
          </span>
          <span x-show="darkMode" class="w-5 h-5" style="display: none;">
            {% icon "sun", { size: 20, class: "w-5 h-5" } %}
          </span>
        </button>

        <!-- Mobile menu button -->
        <button 
          @click="isOpen = !isOpen" 
          class="md:hidden inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 w-10"
          aria-label="Toggle menu"
        >
          <span x-show="!isOpen" class="w-6 h-6">
            {% icon "menu", { size: 24, class: "w-6 h-6" } %}
          </span>
          <span x-show="isOpen" class="w-6 h-6" style="display: none;">
            {% icon "x", { size: 24, class: "w-6 h-6" } %}
          </span>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <nav 
      x-show="isOpen" 
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 transform scale-95"
      x-transition:enter-end="opacity-100 transform scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 transform scale-100"
      x-transition:leave-end="opacity-0 transform scale-95"
      class="md:hidden border-t border-border"
      style="display: none;"
      aria-label="Mobile navigation"
    >
      <ul class="px-2 pt-2 pb-3 space-y-1">
          {% if navigation[lang] %}
            {% for item in navigation[lang] %}
              {% set isActive = page.url | isActive(item.url) %}
              <li>
                <a 
                  href="{{ item.url }}" 
                  @click="isOpen = false"
                  class="block px-3 py-2 rounded-md text-base font-medium transition-colors hover:bg-accent hover:text-accent-foreground {% if isActive %}bg-accent/50 text-primary font-semibold{% else %}text-foreground{% endif %}"
                  {% if isActive %}aria-current="page"{% endif %}
                >
                  {{ item.text }}
                </a>
              </li>
            {% endfor %}
          {% endif %}
      </ul>
    </nav>
  </div>
</nav>
