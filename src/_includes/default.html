<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      {{title}}
    </title>
    {% if description %}
      <meta name="description" content="{{description}}"/>
    {% endif %}
    {% block head %}{% endblock %}
    <!-- Tailwind CSS -->
    <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
    <!-- Swup CSS - Inline for immediate loading -->
    <style>
      /* Swup fade animation - exactly as on swup.js.org */
      html.is-changing {
        overflow-x: hidden;
      }

      /* Define transition duration during page visits */
      html.is-changing .transition-fade {
        transition: opacity 0.25s ease-in-out;
        opacity: 1;
      }

      /* Out animation - page leaving (fades out) */
      html.is-animating .transition-fade,
      html.is-leaving .transition-fade {
        opacity: 0;
      }

      /* In animation - page entering (starts invisible, fades in) */
      html.is-rendering .transition-fade {
        opacity: 0;
      }

      /* Final state - page fully loaded */
      html.is-ready .transition-fade {
        opacity: 1;
      }

      /* Lenis smooth scroll styles */
      html.lenis {
        height: auto;
      }

      .lenis.lenis-smooth {
        scroll-behavior: auto !important;
      }

      .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
      }

      .lenis.lenis-stopped {
        overflow: hidden;
      }

      .lenis.lenis-scrolling iframe {
        pointer-events: none;
      }
    </style>
    <!-- Webflow CSS - Add your Webflow CSS files here -->
    {% if webflow_css %}
      {% for css_file in webflow_css %}
        <link rel="stylesheet" type="text/css" href="/static/webflow/css/{{ css_file }}"/>
      {% endfor %}
    {% endif %}
    {% if prism == true %}
      <link rel="stylesheet" type="text/css" href="/static/css/prism-tomorrow.css">
    {% endif %}
  </head>
  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-200" data-lenis-prevent="false">
    {% include "./partials/navbar.html" %}

    <main id="swup" class="flex-grow transition-fade">
      {{ content | safe }}
    </main>

    {% include "./partials/footer.html" %}

    <!-- Lenis for smooth scrolling -->
    <script src="/static/js/lenis.min.js"></script>
    
    <!-- Swup for page transitions -->
    <script src="/static/js/swup.js"></script>
    <script src="/static/js/swup-scroll-plugin.js"></script>
    <script src="/static/js/swup-head-plugin.js"></script>
    
    <!-- Alpine.js - Initialize after Swup as per documentation -->
    <script src="/static/js/alpine.js"></script>
    <script>
      // Initialize Alpine.js first (as per documentation)
      if (window.Alpine) {
        window.Alpine.start();
      }
      
      // Initialize Lenis and Swup - wait for all scripts to load
      (function initSwupAndLenis() {
        // Check if all required libraries are loaded
        if (typeof Swup === 'undefined' || typeof Lenis === 'undefined') {
          setTimeout(initSwupAndLenis, 50);
          return;
        }

        // Initialize Lenis for smooth scrolling with better settings
        let lenis;
        if (typeof Lenis !== 'undefined') {
          lenis = new Lenis({
            duration: 1.5,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            orientation: 'vertical',
            gestureOrientation: 'vertical',
            smoothWheel: true,
            wheelMultiplier: 0.8, // Slightly slower for smoother feel
            smoothTouch: true, // Enable smooth touch for mobile
            touchMultiplier: 1.5,
            infinite: false,
            lerp: 0.08, // Lower lerp for smoother animation
          });

          // Animation loop for Lenis
          function raf(time) {
            lenis.raf(time);
            requestAnimationFrame(raf);
          }
          requestAnimationFrame(raf);

          // Make Lenis available globally
          window.lenis = lenis;
          console.log('Lenis initialized');
        }

        // Get plugin constructors (UMD modules export to window)
        const ScrollPlugin = window.SwupScrollPlugin;
        const HeadPlugin = window.SwupHeadPlugin;

        const swup = new Swup({
          plugins: [
            ScrollPlugin ? new ScrollPlugin({
              doScrollingRightAway: false,
              animateScroll: false, // Disable Swup's scroll animation, use Lenis instead
              scrollFriction: 0.3,
              scrollAcceleration: 0.04,
            }) : null,
            HeadPlugin ? new HeadPlugin({
              persistTags: 'style[data-swup], link[rel="stylesheet"]',
            }) : null,
          ].filter(Boolean),
          cache: true,
          animateHistoryBrowsing: true,
          animationSelector: '.transition-fade', // As per documentation
          animationScope: 'html', // As per documentation
        });

        console.log('Swup initialized');

        // Alpine.js integration - as per documentation
        // Alpine automatically reinitializes on content replace, but we can ensure it
        swup.hooks.on('content:replace', () => {
          // Alpine.js will auto-initialize, but we can trigger a refresh if needed
          if (window.Alpine) {
            window.Alpine.initTree(document.body);
          }
        });

        // Integrate Lenis with Swup
        if (lenis) {
          // Stop Lenis during page transition for smoother animation
          swup.hooks.on('visit:start', () => {
            lenis.stop();
          });
          
          // Scroll to top on page change
          swup.hooks.on('content:replace', () => {
            // Small delay to ensure content is rendered
            setTimeout(() => {
              lenis.start();
              lenis.scrollTo(0, {
                immediate: false,
                duration: 1.2,
              });
            }, 150);
          });

          // Handle anchor links
          swup.hooks.on('link:anchor', ({ hash }) => {
            setTimeout(() => {
              const element = document.querySelector(hash);
              if (element) {
                lenis.scrollTo(element, {
                  offset: 0,
                  duration: 1.5,
                });
              }
            }, 100);
          });

          // Update Lenis when content changes
          swup.hooks.on('content:replace', () => {
            lenis.resize();
          });
        }

        // Update active navigation item after page transition
        swup.hooks.on('content:replace', () => {
          // Update active navigation item after page transition
          updateActiveNavItem();
        });

        // Function to update active navigation item
        function updateActiveNavItem() {
          const currentUrl = window.location.pathname;
          const navLinks = document.querySelectorAll('nav a[href]');
          
          navLinks.forEach(link => {
            const linkUrl = link.getAttribute('href');
            let isActive = false;
            
            // Check if link matches current URL
            if (linkUrl === currentUrl || (linkUrl === '/' && currentUrl === '/')) {
              isActive = true;
            } else if (linkUrl !== '/' && currentUrl.startsWith(linkUrl)) {
              // For nested routes like /news/posts/article
              // If we're on /news or /news/*, mark News as active
              isActive = true;
            }
            
            // Update classes
            if (isActive) {
              link.classList.add('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
              link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:text-indigo-600', 'dark:hover:text-indigo-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
            } else {
              link.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
              link.classList.add('text-gray-700', 'dark:text-gray-300');
            }
          });
        }

        // Update active nav on initial load
        updateActiveNavItem();

        // Make swup available globally for debugging
        window.swup = swup;
      })();
    </script>
    
    <!-- Webflow JS - Add your Webflow JS files here -->
    {% if webflow_js %}
      {% for js_file in webflow_js %}
        <script src="/static/webflow/js/{{ js_file }}"></script>
      {% endfor %}
    {% endif %}

    {% if path == "home" %}
      <!-- Netlify Identity Widget -->
      <!-- Needed only if you are using Netlify Identity feature -->
      <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    {% endif %}

  </body>
</html>
