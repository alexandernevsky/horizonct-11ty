<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      {{title}}
    </title>
    {% if description %}
      <meta name="description" content="{{description}}"/>
    {% endif %}
    {% block head %}{% endblock %}
    <!-- Local Fonts CSS -->
    <link rel="stylesheet" type="text/css" href="/static/css/fonts.css"/>
    <!-- Tailwind CSS -->
    <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
    <!-- Swup CSS - Inline for immediate loading -->
    <style>
      /* Custom Fonts */
      :root {
        --font-primary: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --font-secondary: 'EB Garamond', Georgia, serif;
      }
      
      body {
        font-family: var(--font-primary);
        font-variation-settings: 'wght' 400;
      }
      
      /* Headings - all use Geist with bold weight */
      h1, h2, h3, h4, h5, h6 {
        font-family: var(--font-primary);
        font-weight: 700;
        font-variation-settings: 'wght' 700;
      }
      
      /* Secondary font ONLY for dates, captions, meta info - NOT for buttons or tags */
      time,
      small,
      .caption,
      .meta,
      .date {
        font-family: var(--font-secondary);
        font-style: italic;
        font-weight: 400;
        font-variation-settings: 'wght' 400;
      }
      
      /* Ensure nav buttons and tags use primary font (Geist) */
      nav a,
      nav button,
      [class*="tag"],
      .tag,
      a[class*="tag"] {
        font-family: var(--font-primary) !important;
        font-style: normal !important;
      }
      
      /* Swup fade animation - exactly as on swup.js.org */
      html.is-changing {
        overflow-x: hidden;
      }

      /* Define transition duration during page visits */
      html.is-changing .transition-fade {
        transition: opacity 0.25s ease-in-out;
        opacity: 1;
      }

      /* Out animation - page leaving (fades out) */
      html.is-animating .transition-fade,
      html.is-leaving .transition-fade {
        opacity: 0;
      }

      /* In animation - page entering (starts invisible, fades in) */
      html.is-rendering .transition-fade {
        opacity: 0;
      }

      /* Final state - page fully loaded */
      html.is-ready .transition-fade {
        opacity: 1;
      }

      /* Lenis smooth scroll styles - official CSS from documentation */
      html.lenis,
      html.lenis body {
        height: auto;
      }

      html.lenis {
        overflow-x: hidden;
      }

      .lenis.lenis-smooth {
        scroll-behavior: auto !important;
      }

      .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
      }

      .lenis.lenis-stopped {
        overflow: hidden;
      }

      .lenis.lenis-scrolling iframe {
        pointer-events: none;
      }

      /* Disable native smooth scroll to let Lenis handle it */
      html {
        scroll-behavior: auto !important;
      }

      /* Ensure Lenis controls scrolling - CRITICAL: don't block overflow */
      body {
        overflow-x: hidden;
        /* Don't set overflow-y: hidden - Lenis needs it to work */
      }
      
      /* Ensure main content is scrollable */
      main#swup {
        /* Allow scrolling */
      }
    </style>
    <!-- Webflow CSS - Add your Webflow CSS files here -->
    {% if webflow_css %}
      {% for css_file in webflow_css %}
        <link rel="stylesheet" type="text/css" href="/static/webflow/css/{{ css_file }}"/>
      {% endfor %}
    {% endif %}
    {% if prism == true %}
      <link rel="stylesheet" type="text/css" href="/static/css/prism-tomorrow.css">
    {% endif %}
  </head>
  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-200" data-lenis-prevent="false">
    {% include "./partials/navbar.html" %}

    <main id="swup" class="flex-grow transition-fade">
      {{ content | safe }}
    </main>

    {% include "./partials/footer.html" %}

    <!-- Lenis for smooth scrolling -->
    <script src="/static/js/lenis.min.js"></script>
    
    <!-- Swup for page transitions -->
    <script src="/static/js/swup.js"></script>
    <script src="/static/js/swup-scroll-plugin.js"></script>
    <script src="/static/js/swup-head-plugin.js"></script>
    
    <!-- Alpine.js - Auto-initializes, don't call start() manually -->
    <script src="/static/js/alpine.js"></script>
    <script>
      // Wait for DOM to be fully ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLenisAndSwup);
      } else {
        initLenisAndSwup();
      }

      function initLenisAndSwup() {
        // Check if Lenis is loaded
        if (typeof Lenis === 'undefined') {
          setTimeout(initLenisAndSwup, 50);
          return;
        }

        // Initialize Lenis FIRST with autoRaf for automatic animation loop
        // Don't specify wrapper/content - let Lenis use defaults (window/document.documentElement)
        const lenis = new Lenis({
          autoRaf: true, // Use automatic RAF loop as per Lenis documentation
          duration: 3.5, // Slower duration for more noticeable smooth scrolling
          easing: (t) => 1 - Math.pow(1 - t, 3),
          orientation: 'vertical',
          gestureOrientation: 'vertical',
          smoothWheel: true,
          wheelMultiplier: 0.3, // Much slower wheel for very noticeable smooth scrolling
          smoothTouch: true,
          touchMultiplier: 0.8,
          infinite: false,
          lerp: 0.08, // Lower lerp for smoother, slower animation
          syncTouch: true,
        });
        
        // Debug: Check if Lenis is actually running
        console.log('Lenis instance:', lenis);
        console.log('Lenis isScrolling:', lenis.isScrolling);
        console.log('Lenis isStopped:', lenis.isStopped);
        
        // Listen to scroll events to verify it's working
        lenis.on('scroll', ({ scroll, limit, velocity, direction, progress }) => {
          // This will fire when Lenis is actually scrolling
          if (Math.abs(velocity) > 0.01) {
            console.log('ðŸ”„ Lenis scrolling:', { 
              scroll: Math.round(scroll), 
              velocity: velocity.toFixed(3),
              direction 
            });
          }
        });

        // Make Lenis available globally
        window.lenis = lenis;
        
        // Function to ensure Lenis classes are on HTML element
        function ensureLenisClasses() {
          const htmlElement = document.documentElement;
          
          // Ensure lenis class is there
          if (!htmlElement.classList.contains('lenis')) {
            htmlElement.classList.add('lenis');
          }
          
          // CRITICAL: Add lenis-smooth class - this enables smooth scrolling
          if (!htmlElement.classList.contains('lenis-smooth')) {
            htmlElement.classList.add('lenis-smooth');
          }
          
          return htmlElement.classList.contains('lenis-smooth');
        }
        
        // Immediately add classes
        ensureLenisClasses();
        
        // CRITICAL: Ensure Lenis is started and running
        lenis.start();
        
        console.log('âœ… Lenis initialized with autoRaf');
        console.log('âœ… Lenis started:', lenis.isStopped ? 'NO (stopped!)' : 'YES (running)');
        
        // Continuously check and restore classes (in case something removes them)
        let checkInterval = setInterval(() => {
          if (!ensureLenisClasses()) {
            console.warn('âš ï¸ lenis-smooth class was removed, restoring...');
          }
        }, 500);
        
        // Stop checking after 5 seconds (by then it should be stable)
        setTimeout(() => {
          clearInterval(checkInterval);
        }, 5000);
        
        // Verify Lenis is working
        setTimeout(() => {
          const htmlElement = document.documentElement;
          const hasLenis = htmlElement.classList.contains('lenis');
          const hasSmooth = htmlElement.classList.contains('lenis-smooth');
          
          console.log('âœ… Lenis status:', {
            hasLenisClass: hasLenis,
            hasSmoothClass: hasSmooth,
            allClasses: htmlElement.className,
            scroll: Math.round(lenis.scroll),
            limit: Math.round(lenis.limit)
          });
          
          if (!hasSmooth) {
            console.error('âŒ lenis-smooth class is missing! Smooth scrolling will not work.');
            // Force add it one more time
            htmlElement.classList.add('lenis-smooth');
            console.log('ðŸ”§ Force-added lenis-smooth class');
          }
        }, 200);
        
        // Make function available globally for Swup hooks
        window.ensureLenisClasses = ensureLenisClasses;

        // Now initialize Swup WITHOUT Scroll Plugin to avoid conflicts
        if (typeof Swup === 'undefined') {
          setTimeout(() => {
            if (typeof Swup !== 'undefined') {
              initSwup(lenis);
            }
          }, 50);
          return;
        }

        initSwup(lenis);
      }

      function initSwup(lenis) {
        // Get plugin constructors (UMD modules export to window)
        const HeadPlugin = window.SwupHeadPlugin;

        // DO NOT use ScrollPlugin - it conflicts with Lenis
        const swup = new Swup({
          containers: ['#swup'], // Explicitly specify container
          plugins: [
            HeadPlugin ? new HeadPlugin({
              persistTags: 'style[data-swup], link[rel="stylesheet"]',
            }) : null,
          ].filter(Boolean),
          cache: true,
          animateHistoryBrowsing: true,
          animationSelector: '.transition-fade',
          animationScope: 'html',
        });

        console.log('âœ… Swup initialized (Scroll Plugin disabled for Lenis)');

        // Alpine.js integration - Alpine auto-initializes, just refresh tree
        swup.hooks.on('content:replace', () => {
          // Alpine automatically reinitializes, but we can ensure it
          // Don't call Alpine.start() as it's already initialized
        });

        // Integrate Lenis with Swup
        if (lenis) {
          // Make sure Lenis is started initially
          lenis.start();
          console.log('âœ… Lenis started after Swup init');
          
          // Stop Lenis during page transition
          swup.hooks.on('visit:start', () => {
            lenis.stop();
            console.log('â¸ï¸ Lenis stopped for page transition');
          });
          
          // Restart Lenis and scroll to top after content is replaced
          swup.hooks.on('content:replace', () => {
            // CRITICAL: Re-add lenis-smooth class after Swup replaces content
            // Swup may remove classes from HTML element
            if (window.ensureLenisClasses) {
              window.ensureLenisClasses();
            } else {
              const htmlElement = document.documentElement;
              if (!htmlElement.classList.contains('lenis')) {
                htmlElement.classList.add('lenis');
              }
              if (!htmlElement.classList.contains('lenis-smooth')) {
                htmlElement.classList.add('lenis-smooth');
              }
            }
            
            // Resize Lenis to recalculate scroll height
            lenis.resize();
            
            // Small delay to ensure DOM is ready
            setTimeout(() => {
              // Ensure classes are still there
              if (window.ensureLenisClasses) {
                window.ensureLenisClasses();
              }
              
              lenis.start();
              lenis.scrollTo(0, {
                immediate: true, // Immediate scroll to top on page change
              });
            }, 100);
          });

          // Handle anchor links with Lenis
          swup.hooks.on('link:anchor', ({ hash }) => {
            setTimeout(() => {
              const element = document.querySelector(hash);
              if (element) {
                lenis.scrollTo(element, {
                  offset: 0,
                  duration: 1.5,
                });
              }
            }, 100);
          });
        }

        // Update active navigation item after page transition
        swup.hooks.on('content:replace', () => {
          // Update active navigation item after page transition
          updateActiveNavItem();
        });

        // Function to update active navigation item
        function updateActiveNavItem() {
          const currentUrl = window.location.pathname;
          const navLinks = document.querySelectorAll('nav a[href]');
          
          navLinks.forEach(link => {
            const linkUrl = link.getAttribute('href');
            
            // Check if this is the logo (in flex-shrink-0 div) - never make it active
            const isLogo = link.closest('.flex-shrink-0') !== null;
            if (isLogo) {
              // Remove any active classes from logo
              link.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
              return;
            }
            
            let isActive = false;
            
            // Check if link matches current URL
            if (linkUrl === currentUrl || (linkUrl === '/' && currentUrl === '/')) {
              isActive = true;
            } else if (linkUrl !== '/' && currentUrl.startsWith(linkUrl)) {
              // For nested routes like /news/posts/article
              // If we're on /news or /news/*, mark News as active
              isActive = true;
            }
            
            // Update classes
            if (isActive) {
              link.classList.add('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
              link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:text-indigo-600', 'dark:hover:text-indigo-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
            } else {
              link.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
              link.classList.add('text-gray-700', 'dark:text-gray-300');
            }
          });
        }

        // Update active nav on initial load
        updateActiveNavItem();

        // Make swup available globally for debugging
        window.swup = swup;
      }
    </script>
    
    <!-- Webflow JS - Add your Webflow JS files here -->
    {% if webflow_js %}
      {% for js_file in webflow_js %}
        <script src="/static/webflow/js/{{ js_file }}"></script>
      {% endfor %}
    {% endif %}

    {% if path == "home" %}
      <!-- Netlify Identity Widget -->
      <!-- Needed only if you are using Netlify Identity feature -->
      <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    {% endif %}

  </body>
</html>
