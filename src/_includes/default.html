<!DOCTYPE html>
<html lang="{% if lang %}{{ lang }}{% else %}en{% endif %}">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Variables -->
    {% if seo and seo.seo_title %}
      {% set page_seo_title = seo.seo_title %}
    {% elif seo_title %}
      {% set page_seo_title = seo_title %}
    {% else %}
      {% set page_seo_title = title %}
    {% endif %}
    
    {% if seo and seo.seo_description %}
      {% set page_seo_description = seo.seo_description %}
    {% elif seo_description %}
      {% set page_seo_description = seo_description %}
    {% else %}
      {% set page_seo_description = description %}
    {% endif %}
    
    {% if seo and seo.keywords %}
      {% set page_keywords = seo.keywords %}
    {% else %}
      {% set page_keywords = keywords %}
    {% endif %}
    
    {% if seo and seo.robots %}
      {% set page_robots = seo.robots %}
    {% elif robots %}
      {% set page_robots = robots %}
    {% else %}
      {% set page_robots = 'index, follow' %}
    {% endif %}
    
    {% if seo and seo.og_image %}
      {% set page_og_image = seo.og_image %}
    {% else %}
      {% set page_og_image = og_image %}
    {% endif %}
    
    {% if seo and seo.twitter_card %}
      {% set page_twitter_card = seo.twitter_card %}
    {% elif twitter_card %}
      {% set page_twitter_card = twitter_card %}
    {% else %}
      {% set page_twitter_card = 'summary_large_image' %}
    {% endif %}
    
    <!-- Primary Meta Tags -->
    <title>{{ page_seo_title }}</title>
    <meta name="title" content="{{ page_seo_title }}">
    <meta name="description" content="{{ page_seo_description }}">
    {% if page_keywords %}
    <meta name="keywords" content="{{ page_keywords }}">
    {% endif %}
    <meta name="author" content="{% if seo_author %}{{ seo_author }}{% else %}{{ settings.author }}{% endif %}">
    <meta name="robots" content="{{ page_robots }}">
    <meta name="language" content="{% if lang %}{{ lang }}{% else %}English{% endif %}">
    <meta name="revisit-after" content="7 days">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ settings.url }}{{ page.url }}">
    <!-- Alternate Language Links -->
    {% if lang == 'ru' %}
      {% set altLang = 'en' %}
      {% set altUrl = page.url | replace('/ru/', '/') %}
      {% if altUrl == '/ru/' %}
        {% set altUrl = '/' %}
      {% endif %}
    {% else %}
      {% set altLang = 'ru' %}
      {% if page.url == '/' %}
        {% set altUrl = '/ru/' %}
      {% else %}
        {% set altUrl = '/ru' + page.url %}
      {% endif %}
    {% endif %}
    {% set isNewsPage = false %}
    {% if page.url == '/news' %}
      {% set isNewsPage = true %}
    {% endif %}
    {% set newsPrefix = page.url | slice(0, 6) %}
    {% if newsPrefix == '/news/' %}
      {% set isNewsPage = true %}
    {% endif %}
    {% if not isNewsPage %}
    <link rel="alternate" hreflang="{{ altLang }}" href="{{ settings.url }}{{ altUrl }}">
    {% if lang %}
    <link rel="alternate" hreflang="{{ lang }}" href="{{ settings.url }}{{ page.url }}">
    {% else %}
    <link rel="alternate" hreflang="en" href="{{ settings.url }}{{ page.url }}">
    {% endif %}
    {% endif %}
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="{% if og_type %}{{ og_type }}{% else %}website{% endif %}">
    <meta property="og:url" content="{{ settings.url }}{{ page.url }}">
    <meta property="og:title" content="{% if og_title %}{{ og_title }}{% else %}{{ page_seo_title }}{% endif %}">
    <meta property="og:description" content="{% if og_description %}{{ og_description }}{% else %}{{ page_seo_description }}{% endif %}">
    {% if page_og_image %}
    <meta property="og:image" content="{{ settings.url }}{{ page_og_image }}">
    {% if seo %}
      {% if seo.og_image_width %}
      <meta property="og:image:width" content="{{ seo.og_image_width }}">
      {% elif og_image_width %}
      <meta property="og:image:width" content="{{ og_image_width }}">
      {% else %}
      <meta property="og:image:width" content="1200">
      {% endif %}
      {% if seo.og_image_height %}
      <meta property="og:image:height" content="{{ seo.og_image_height }}">
      {% elif og_image_height %}
      <meta property="og:image:height" content="{{ og_image_height }}">
      {% else %}
      <meta property="og:image:height" content="630">
      {% endif %}
    {% else %}
      {% if og_image_width %}
      <meta property="og:image:width" content="{{ og_image_width }}">
      {% else %}
      <meta property="og:image:width" content="1200">
      {% endif %}
      {% if og_image_height %}
      <meta property="og:image:height" content="{{ og_image_height }}">
      {% else %}
      <meta property="og:image:height" content="630">
      {% endif %}
    {% endif %}
    {% endif %}
    <meta property="og:site_name" content="{{ settings.company_name }}">
    <meta property="og:locale" content="{% if og_locale %}{{ og_locale }}{% else %}en_US{% endif %}">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="{{ page_twitter_card }}">
    <meta name="twitter:url" content="{{ settings.url }}{{ page.url }}">
    <meta name="twitter:title" content="{% if twitter_title %}{{ twitter_title }}{% else %}{{ page_seo_title }}{% endif %}">
    <meta name="twitter:description" content="{% if twitter_description %}{{ twitter_description }}{% else %}{{ page_seo_description }}{% endif %}">
    {% if twitter_image %}
    <meta name="twitter:image" content="{{ settings.url }}{{ twitter_image }}">
    {% elif page_og_image %}
    <meta name="twitter:image" content="{{ settings.url }}{{ page_og_image }}">
    {% endif %}
    {% if twitter_site %}
    <meta name="twitter:site" content="{{ twitter_site }}">
    {% endif %}
    {% if twitter_creator %}
    <meta name="twitter:creator" content="{{ twitter_creator }}">
    {% endif %}
    
    <!-- Article Meta (for blog posts) -->
    {% if article_published_time %}
    <meta property="article:published_time" content="{{ article_published_time }}">
    {% endif %}
    {% if article_modified_time %}
    <meta property="article:modified_time" content="{{ article_modified_time }}">
    {% endif %}
    {% if article_author %}
    <meta property="article:author" content="{{ article_author }}">
    {% endif %}
    {% if article_section %}
    <meta property="article:section" content="{{ article_section }}">
    {% endif %}
    {% if article_tags %}
      {% for tag in article_tags %}
      <meta property="article:tag" content="{{ tag }}">
      {% endfor %}
    {% endif %}
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="{% if theme_color %}{{ theme_color }}{% else %}#4F46E5{% endif %}">
    <meta name="msapplication-TileColor" content="{% if theme_color %}{{ theme_color }}{% else %}#4F46E5{% endif %}">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "{{ settings.company_name }}",
      "url": "{{ settings.url }}",
      "logo": "{{ settings.url }}/static/img/logo.png",
      "description": "{{ page_seo_description }}",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "{{ settings.address }}",
        "addressLocality": "Hong Kong",
        "addressCountry": "HK"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": "{{ settings.phone }}",
        "contactType": "customer service",
        "email": "{{ settings.email }}"
      }
    }
    </script>
    
    {% block head %}{% endblock %}
    <!-- Local Fonts CSS -->
    <link rel="stylesheet" type="text/css" href="/static/css/fonts.css"/>
    <!-- Tailwind CSS -->
    <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
    <!-- Swup CSS - Inline for immediate loading -->
    <style>
      /* Custom Fonts */
      :root {
        --font-primary: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --font-secondary: 'EB Garamond', Georgia, serif;
      }
      
      body {
        font-family: var(--font-primary);
        font-variation-settings: 'wght' 400;
      }
      
      /* Headings - all use Geist with bold weight */
      h1, h2, h3, h4, h5, h6 {
        font-family: var(--font-primary);
        font-weight: 700;
        font-variation-settings: 'wght' 700;
      }
      
      /* Secondary font ONLY for dates, captions, meta info - NOT for buttons or tags */
      time,
      small,
      .caption,
      .meta,
      .date {
        font-family: var(--font-secondary);
        font-style: italic;
        font-weight: 400;
        font-variation-settings: 'wght' 400;
      }
      
      /* Ensure nav buttons and tags use primary font (Geist) */
      nav a,
      nav button,
      [class*="tag"],
      .tag,
      a[class*="tag"] {
        font-family: var(--font-primary) !important;
        font-style: normal !important;
      }
      
      /* Native Smooth Scrolling - enabled by default */
      html {
        scroll-behavior: smooth;
      }

      /* Disable smooth scroll during Swup page transitions - CRITICAL */
      /* This prevents slow scrolling to top when Swup changes pages */
      html.is-changing,
      html.is-animating,
      html.is-leaving,
      html.is-rendering {
        scroll-behavior: auto !important;
      }

      /* Swup fade animation - exactly as on swup.js.org */
      html.is-changing {
        overflow-x: hidden;
      }

      /* Define transition duration during page visits */
      html.is-changing .transition-fade {
        transition: opacity 0.25s ease-in-out;
        opacity: 1;
      }

      /* Out animation - page leaving (fades out) */
      html.is-animating .transition-fade,
      html.is-leaving .transition-fade {
        opacity: 0;
      }

      /* In animation - page entering (starts invisible, fades in) */
      html.is-rendering .transition-fade {
        opacity: 0;
      }

      /* Final state - page fully loaded */
      html.is-ready .transition-fade {
        opacity: 1;
      }

    </style>
    <!-- Webflow CSS - Add your Webflow CSS files here -->
    {% if webflow_css %}
      {% for css_file in webflow_css %}
        <link rel="stylesheet" type="text/css" href="/static/webflow/css/{{ css_file }}"/>
      {% endfor %}
    {% endif %}
    {% if prism == true %}
      <link rel="stylesheet" type="text/css" href="/static/css/prism-tomorrow.css">
    {% endif %}
  </head>
  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-200">
    {% include "./partials/navbar.html" %}

    <main id="swup" class="flex-grow transition-fade">
      {{ content | safe }}
    </main>

    {% include "./partials/footer.html" %}

    <!-- Swup for page transitions -->
    <script src="/static/js/swup.js"></script>
    <script src="/static/js/swup-head-plugin.js"></script>
    
    <!-- Alpine.js - Auto-initializes, don't call start() manually -->
    <script src="/static/js/alpine.js"></script>
    <script>
      // Initialize Swup
      (function() {
        if (typeof Swup === 'undefined') {
          setTimeout(arguments.callee, 50);
          return;
        }
        
        const HeadPlugin = window.SwupHeadPlugin;
        const swup = new Swup({
          containers: ['#swup'],
          plugins: [
            HeadPlugin ? new HeadPlugin({
              persistTags: 'style[data-swup], link[rel="stylesheet"]',
            }) : null,
          ].filter(Boolean),
          cache: true,
          animateHistoryBrowsing: true,
          animationSelector: '.transition-fade',
          animationScope: 'html',
        });

        console.log('âœ… Swup initialized');

        // Scroll to top on page transition
        swup.hooks.on('content:replace', () => {
          window.scrollTo(0, 0);
        });

        // Handle anchor links
        swup.hooks.on('link:anchor', ({ hash }) => {
          setTimeout(() => {
            const element = document.querySelector(hash);
            if (element) {
              element.scrollIntoView({ behavior: 'smooth' });
            }
          }, 100);
        });

        // Update active navigation item after page transition
        swup.hooks.on('content:replace', () => {
          updateActiveNavItem();
        });
        
        // Make swup available globally
        window.swup = swup;
      })();

      // Function to update active navigation item
      function updateActiveNavItem() {
        const currentUrl = window.location.pathname;
        const navLinks = document.querySelectorAll('nav a[href]');
        
        navLinks.forEach(link => {
          const linkUrl = link.getAttribute('href');
          
          // Check if this is the logo (in flex-shrink-0 div) - never make it active
          const isLogo = link.closest('.flex-shrink-0') !== null;
          if (isLogo) {
            // Remove any active classes from logo
            link.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
            return;
          }
          
          let isActive = false;
          
          // Check if link matches current URL
          if (linkUrl === currentUrl || (linkUrl === '/' && currentUrl === '/')) {
            isActive = true;
          } else if (linkUrl !== '/' && currentUrl.startsWith(linkUrl)) {
            // For nested routes like /news/posts/article
            // If we're on /news or /news/*, mark News as active
            isActive = true;
          }
          
          // Update classes
          if (isActive) {
            link.classList.add('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
            link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:text-indigo-600', 'dark:hover:text-indigo-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
          } else {
            link.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
            link.classList.add('text-gray-700', 'dark:text-gray-300');
          }
        });
      }

      // Update active nav on initial load
      updateActiveNavItem();

      // Make swup available globally for debugging
      window.swup = swup;
    </script>
    
    <!-- Webflow JS - Add your Webflow JS files here -->
    {% if webflow_js %}
      {% for js_file in webflow_js %}
        <script src="/static/webflow/js/{{ js_file }}"></script>
      {% endfor %}
    {% endif %}

    {% if path == "home" %}
      <!-- Netlify Identity Widget -->
      <!-- Needed only if you are using Netlify Identity feature -->
      <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    {% endif %}

  </body>
</html>