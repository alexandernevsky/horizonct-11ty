<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      {{title}}
    </title>
    {% if description %}
      <meta name="description" content="{{description}}"/>
    {% endif %}
    {% block head %}{% endblock %}
    <!-- Local Fonts CSS -->
    <link rel="stylesheet" type="text/css" href="/static/css/fonts.css"/>
    <!-- Tailwind CSS -->
    <link rel="stylesheet" type="text/css" href="/static/css/style.css"/>
    <!-- Swup CSS - Inline for immediate loading -->
    <style>
      /* Custom Fonts */
      :root {
        --font-primary: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --font-secondary: 'EB Garamond', Georgia, serif;
      }
      
      body {
        font-family: var(--font-primary);
        font-variation-settings: 'wght' 400;
      }
      
      /* Headings - all use Geist with bold weight */
      h1, h2, h3, h4, h5, h6 {
        font-family: var(--font-primary);
        font-weight: 700;
        font-variation-settings: 'wght' 700;
      }
      
      /* Secondary font ONLY for dates, captions, meta info - NOT for buttons or tags */
      time,
      small,
      .caption,
      .meta,
      .date {
        font-family: var(--font-secondary);
        font-style: italic;
        font-weight: 400;
        font-variation-settings: 'wght' 400;
      }
      
      /* Ensure nav buttons and tags use primary font (Geist) */
      nav a,
      nav button,
      [class*="tag"],
      .tag,
      a[class*="tag"] {
        font-family: var(--font-primary) !important;
        font-style: normal !important;
      }
      
      /* Native Smooth Scrolling - enabled by default */
      html {
        scroll-behavior: smooth;
      }

      /* Disable smooth scroll during Swup page transitions - CRITICAL */
      /* This prevents slow scrolling to top when Swup changes pages */
      html.is-changing,
      html.is-animating,
      html.is-leaving,
      html.is-rendering {
        scroll-behavior: auto !important;
      }

      /* Swup fade animation - exactly as on swup.js.org */
      html.is-changing {
        overflow-x: hidden;
      }

      /* Define transition duration during page visits */
      html.is-changing .transition-fade {
        transition: opacity 0.25s ease-in-out;
        opacity: 1;
      }

      /* Out animation - page leaving (fades out) */
      html.is-animating .transition-fade,
      html.is-leaving .transition-fade {
        opacity: 0;
      }

      /* In animation - page entering (starts invisible, fades in) */
      html.is-rendering .transition-fade {
        opacity: 0;
      }

      /* Final state - page fully loaded */
      html.is-ready .transition-fade {
        opacity: 1;
      }

    </style>
    <!-- Webflow CSS - Add your Webflow CSS files here -->
    {% if webflow_css %}
      {% for css_file in webflow_css %}
        <link rel="stylesheet" type="text/css" href="/static/webflow/css/{{ css_file }}"/>
      {% endfor %}
    {% endif %}
    {% if prism == true %}
      <link rel="stylesheet" type="text/css" href="/static/css/prism-tomorrow.css">
    {% endif %}
  </head>
  <body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-200">
    {% include "./partials/navbar.html" %}

    <main id="swup" class="flex-grow transition-fade">
      {{ content | safe }}
    </main>

    {% include "./partials/footer.html" %}

    <!-- Swup for page transitions -->
    <script src="/static/js/swup.js"></script>
    <script src="/static/js/swup-head-plugin.js"></script>
    
    <!-- Alpine.js - Auto-initializes, don't call start() manually -->
    <script src="/static/js/alpine.js"></script>
    <script>
      // Initialize Swup
      (function() {
        if (typeof Swup === 'undefined') {
          setTimeout(arguments.callee, 50);
          return;
        }
        
        const HeadPlugin = window.SwupHeadPlugin;
        const swup = new Swup({
          containers: ['#swup'],
          plugins: [
            HeadPlugin ? new HeadPlugin({
              persistTags: 'style[data-swup], link[rel="stylesheet"]',
            }) : null,
          ].filter(Boolean),
          cache: true,
          animateHistoryBrowsing: true,
          animationSelector: '.transition-fade',
          animationScope: 'html',
        });

        console.log('âœ… Swup initialized');

        // Scroll to top on page transition
        swup.hooks.on('content:replace', () => {
          window.scrollTo(0, 0);
        });

        // Handle anchor links
        swup.hooks.on('link:anchor', ({ hash }) => {
          setTimeout(() => {
            const element = document.querySelector(hash);
            if (element) {
              element.scrollIntoView({ behavior: 'smooth' });
            }
          }, 100);
        });

        // Update active navigation item after page transition
        swup.hooks.on('content:replace', () => {
          updateActiveNavItem();
        });
        
        // Make swup available globally
        window.swup = swup;
      })();

      // Function to update active navigation item
      function updateActiveNavItem() {
        const currentUrl = window.location.pathname;
        const navLinks = document.querySelectorAll('nav a[href]');
        
        navLinks.forEach(link => {
          const linkUrl = link.getAttribute('href');
          
          // Check if this is the logo (in flex-shrink-0 div) - never make it active
          const isLogo = link.closest('.flex-shrink-0') !== null;
          if (isLogo) {
            // Remove any active classes from logo
            link.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
            return;
          }
          
          let isActive = false;
          
          // Check if link matches current URL
          if (linkUrl === currentUrl || (linkUrl === '/' && currentUrl === '/')) {
            isActive = true;
          } else if (linkUrl !== '/' && currentUrl.startsWith(linkUrl)) {
            // For nested routes like /news/posts/article
            // If we're on /news or /news/*, mark News as active
            isActive = true;
          }
          
          // Update classes
          if (isActive) {
            link.classList.add('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
            link.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:text-indigo-600', 'dark:hover:text-indigo-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
          } else {
            link.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-100', 'dark:bg-indigo-900/30', 'font-semibold', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
            link.classList.add('text-gray-700', 'dark:text-gray-300');
          }
        });
      }

      // Update active nav on initial load
      updateActiveNavItem();

      // Make swup available globally for debugging
      window.swup = swup;
    </script>
    
    <!-- Webflow JS - Add your Webflow JS files here -->
    {% if webflow_js %}
      {% for js_file in webflow_js %}
        <script src="/static/webflow/js/{{ js_file }}"></script>
      {% endfor %}
    {% endif %}

    {% if path == "home" %}
      <!-- Netlify Identity Widget -->
      <!-- Needed only if you are using Netlify Identity feature -->
      <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    {% endif %}

  </body>
</html>